import { additionalElem } from '@/common/hooks/utils';
import { genKey } from '@/common/utils/keyGen';
import { create } from 'zustand';

export interface ChatRecordProps {
  role?: bubbleType;
  children?: string;
  additionalElem?: React.ReactNode;
  last?: boolean;
  renderFunction?: (
    children: string,
    additionalElem?: React.ReactNode,
    setReadyState?: () => void,
    last?: boolean
  ) => React.ReactNode;
}
export type fileInfoType = {
  url: string;
  status: 'success' | 'progressing' | 'fail';
};
export type inputType = {
  text: string;
  files?: fileInfoType[];
};
export type ChatHistoryItemType = {
  date: string;
  title: string;
  id: string;
};

export type HistoryByDateType = {
  [key: string]: ChatHistoryItemType[];
};

export type bubbleType = 'robot' | 'user';
interface ChatStore {
  chatHistories: ChatHistoryItemType[];
  chatRecords: ChatRecordProps[];
  currentSelect: string;
  addNewHistory: (title: string) => void;
  sendMessage: (role: bubbleType, text: string) => void;
  replaceMessage: (role: bubbleType, text: string) => void;
  refreshChatRecords: (id?: string) => void;
  setCurrentSelect: (id: string) => void;
}
interface ChatInputStore {
  inputs: inputType;
  setText: (text: string) => void;
  setFiles: (texts: any[]) => void;
  setPlugins: (name: string, res: string) => void;
  removeFiles: () => void;
}
export const useChat = create<ChatStore>((set) => ({
  chatHistories: [
    {
      date: '2024/04/12',
      title: 'å€™æ™“èˆŸåšå£«ç”Ÿå¹³',
      id: '1',
    },
  ],
  chatRecords: [
    {
      role: 'robot',
      children: `## ä½ å¥½ðŸ‘‹\n #### æˆ‘æ˜¯è¯­è¨€ç§‘ç ”å°åŠ©æ‰‹ï½ž \n #### è¯•ç€è¿™æ ·é—®æˆ‘ï¼š
      `,
      additionalElem: additionalElem,
    },
    {
      role: 'user',
      children: 'ä¾¯æ™“èˆŸæ•™æŽˆåœ¨è¯­æ–™åº“è¯­è¨€å­¦é¢†åŸŸæœ‰å“ªäº›ä¸»è¦çš„ç ”ç©¶æˆæžœï¼Ÿ'
    }, {
    role: 'robot',
      children: '### ä¾¯æ™“èˆŸæ•™æŽˆåœ¨è¯­æ–™åº“è¯­è¨€å­¦é¢†åŸŸæœ‰å¤šé¡¹ç ”ç©¶æˆæžœï¼Œæ ¹æ®æœç´¢å¾—åˆ°çš„ä¿¡æ¯ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›ä¸»è¦çš„æˆæžœï¼š\n' +
        '\n' +
        '1. ä¸»æŒå¹¶å®Œæˆäº†å¤šä¸ªä¸Žè¯­æ–™åº“è¯­è¨€å­¦ç›¸å…³çš„ç§‘ç ”é¡¹ç›®ï¼ŒåŒ…æ‹¬åŸºäºŽé€æ­¥å¤šå…ƒå›žå½’çš„é«˜æ ¡å­¦ç”Ÿè¯­è¨€èƒ½åŠ›å½±å“å› ç´ ç ”ç©¶ã€ä¸“ä¸šè‹±è¯­ï¼ˆæ•™è‚²å­¦ï¼‰è¯¾ç¨‹æ€æ”¿ç¤ºèŒƒè¯¾ç¨‹ã€åŸºäºŽè¯­æ–™åº“è¯­ç”¨å­¦çš„è‹±è¯­è¯­ç”¨çŸ¥è¯†æ˜¾æ€§æ•™å­¦æ¨¡å¼ç ”ç©¶ã€åŸºäºŽERPçš„æ±‰è‹±è¯æ±‡è¯­ç”¨ä¿¡æ¯åŠ å·¥å¤„ç†ç ”ç©¶ç­‰ã€‚\n' +
        '\n' +
        '2. å‘è¡¨äº†å¤šç¯‡ä¸Žè¯­æ–™åº“è¯­è¨€å­¦ç›¸å…³çš„å­¦æœ¯è®ºæ–‡ï¼Œä¾‹å¦‚æŽ¢è®¨è¯­å¢ƒä¿¡æ¯å¯¹è¯æ±‡è¯­ç”¨ä¿¡æ¯è®¤çŸ¥ç†è§£çš„æž„å»ºã€åŸºäºŽååº”æ—¶çš„ç¬¬äºŒè¯­è¨€å­¦ä¹ è€…è¯­ç”¨è´Ÿè¿ç§»ã€è¯è¯­æ ‡è®°è¯­è¯­æ–™åº“èµ‹ç åŽŸåˆ™ç ”ç©¶ç­‰ã€‚\n' +
        '\n' +
        '3. ä¾¯æ™“èˆŸæ•™æŽˆåœ¨è¯­æ–™åº“è¯­è¨€å­¦çš„æ•™å­¦å’Œç ”ç©¶æ–¹é¢å…·æœ‰ä¸°å¯Œçš„ç»éªŒï¼Œä¸»è®²çš„è¯¾ç¨‹åŒ…æ‹¬åŸºç¡€è‹±è¯­ã€è‹±è¯­è¯­è¨€å­¦ã€çŽ°ä»£ç†è®ºè¯­è¨€å­¦ã€è¯­æ–™åº“è¯­è¨€å­¦ç­‰ã€‚\n' +
        '\n' +
        '4. ä¾¯æ™“èˆŸæ•™æŽˆçš„ç ”ç©¶æˆæžœåœ¨å­¦æœ¯ç•ŒèŽ·å¾—äº†ä¸€å®šçš„è®¤å¯ï¼ŒèŽ·å¾—äº†åŒ…æ‹¬æ²³åŒ—çœç¤¾ä¼šç§‘å­¦ä¼˜ç§€æˆæžœå¥–ã€æ²³åŒ—çœç ”ç©¶ç”Ÿè¯¾ç¨‹æ€æ”¿æ•™å­¦åå¸ˆï¼ˆå›¢é˜Ÿï¼‰ã€æ²³åŒ—çœâ€œä¸‰ä¸‰ä¸‰äººæ‰å·¥ç¨‹â€ä¸‰å±‚æ¬¡äººæ‰ç­‰è£èª‰ã€‚\n' +
        '\n' +
        '5. ä¾¯æ™“èˆŸæ•™æŽˆè¿˜ç§¯æžå‚ä¸Žå­¦æœ¯å›¢ä½“å·¥ä½œï¼Œæ‹…ä»»å…¨å›½è¯è¯­è¯­è¨€å­¦ç ”ç©¶ä¼šå‰¯ç§˜ä¹¦é•¿ã€æ²³åŒ—å¤§å­¦é«˜ç­‰æ•™è‚²ä¸ŽåŒºåŸŸå‘å±•ç ”ç©¶ä¸­å¿ƒç ”ç©¶å‘˜ç­‰èŒåŠ¡ã€‚\n' +
        '\n' +
        'ä¾¯æ™“èˆŸæ•™æŽˆçš„ç ”ç©¶æˆæžœä½“çŽ°äº†ä»–åœ¨è¯­æ–™åº“è¯­è¨€å­¦é¢†åŸŸçš„æ·±å…¥ç ”ç©¶å’Œä¸“ä¸šè´¡çŒ®ã€‚'
    },
    {
      role: 'user',
      children: 'è¯´è¯´è¿™ç¯‡æ–‡ç« çš„ä¸»è¦å†…å®¹'
    },
    {
      role: 'robot',
      children: 'è¿™ç¯‡æ–‡ç« çš„æ ‡é¢˜æ˜¯ã€Šè¯­æ–™åº“è¯­è¨€å­¦æœªæ¥çš„å‘å±•è·¯å¾„ç ”ç©¶â€”â€”ä»¥â€œåŸºäºŽè¯­æ–™åº“â€çš„ç ”ç©¶èŒƒå¼ä¸ºè§†è§’ã€‹ï¼Œä¸»è¦æŽ¢è®¨äº†è¯­æ–™åº“è¯­è¨€å­¦çš„å‘å±•åŽ†ç¨‹ã€ä¸¤ç§ä¸»è¦ç ”ç©¶èŒƒå¼åŠå…¶ç‰¹ç‚¹ã€åˆ†æ­§ï¼Œå¹¶å¯¹æœªæ¥çš„å‘å±•æ–¹å‘è¿›è¡Œäº†å±•æœ›ã€‚\n' +
        '\n' +
        '## 1. å¼•è¨€\n' +
        'æ–‡ç« ä»Ž20ä¸–çºª60å¹´ä»£ä¸–ç•Œä¸Šç¬¬ä¸€ä¸ªè¯­æ–™åº“â€”â€”å¸ƒæœ—è¯­æ–™åº“çš„å»ºç«‹è®²èµ·ï¼Œè¯´æ˜Žäº†è¯­æ–™åº“è¯­è¨€å­¦çš„èµ·æºå’Œå®ƒåœ¨80å¹´ä»£çš„æ™®åŠã€‚æ–‡ç« æŒ‡å‡ºï¼Œè¯­æ–™åº“è¯­è¨€å­¦çš„å‘å±•ä¸Žä¸¤ä¸ªå¯¹ç«‹çš„ç ”ç©¶èŒƒå¼æœ‰å…³ï¼šåŸºäºŽè¯­æ–™åº“çš„ç ”ç©¶èŒƒå¼å’Œè¯­æ–™åº“é©±åŠ¨çš„ç ”ç©¶èŒƒå¼ã€‚\n' +
        '\n' +
        '## 2. ä¸¤ç§ç ”ç©¶èŒƒå¼çš„èµ·æº\n' +
        'åŸºäºŽè¯­æ–™åº“çš„ç ”ç©¶èŒƒå¼ï¼šç”±å¸ƒæœ—è¯­æ–™åº“å›¢é˜Ÿã€å¤¸å…‹å›¢é˜Ÿå’Œåˆ©å¥‡å›¢é˜Ÿçš„ç›¸äº’äº¤æµå½±å“å½¢æˆã€‚è¿™äº›å›¢é˜Ÿçš„å·¥ä½œä¸ºè¯­æ–™åº“è¯­è¨€å­¦å¥ å®šäº†åŸºç¡€ï¼Œå¹¶ä¸”å¯¹åŽæ¥çš„ç ”ç©¶äº§ç”Ÿäº†æ·±è¿œå½±å“ã€‚\n' +
        'è¯­æ–™åº“é©±åŠ¨çš„ç ”ç©¶èŒƒå¼ï¼šèµ·æºäºŽå¼—æ–¯çš„è¯­å¢ƒè®ºï¼Œç”±ä»–çš„å­¦ç”Ÿä»¬å‘å±•ï¼Œç‰¹åˆ«æ˜¯è¾›å…‹èŽ±å°”ï¼Œä»–ä»¬ä¸»å¼ ä»Žè¯­æ–™åº“ä¸­å»ºæž„ç†è®ºï¼Œå¼ºè°ƒæ­é…å’Œæ„ä¹‰çš„å¯†ä¸å¯åˆ†ã€‚\n' +
        '## 3. ä¸¤ç§ç ”ç©¶èŒƒå¼çš„åˆ†æ­§\n' +
        'æ–‡ç« è¯¦ç»†åŒºåˆ†äº†ä¸¤ç§èŒƒå¼åœ¨å“²å­¦åŸºç¡€ã€å­¦ç§‘å±žæ€§ã€ç ”ç©¶ç›®çš„å’Œæ“ä½œæ‰‹æ®µä¸Šçš„ä¸åŒï¼š\n' +
        '\n' +
        'å“²å­¦åŸºç¡€ï¼šåŸºäºŽè¯­æ–™åº“çš„ç ”ç©¶èŒƒå¼å€¾å‘äºŽâ€œæ¸©å’Œçš„ç»éªŒä¸»ä¹‰â€ï¼Œè€Œè¯­æ–™åº“é©±åŠ¨çš„ç ”ç©¶èŒƒå¼å€¾å‘äºŽâ€œæ¿€è¿›çš„ç»éªŒä¸»ä¹‰â€ã€‚\n' +
        'å­¦ç§‘å±žæ€§ï¼šå‰è€…ä¸è®¤ä¸ºè¯­æ–™åº“è¯­è¨€å­¦æ˜¯ç‹¬ç«‹å­¦ç§‘ï¼Œè€ŒåŽè€…åˆ™è®¤ä¸ºå®ƒæ˜¯ç‹¬ç«‹çš„ï¼Œå¹¶ä¸”æå€¡æ‘†è„±çŽ°æœ‰è¯­è¨€åˆ†ç±»ä½“ç³»ã€‚\n' +
        'ç ”ç©¶ç›®çš„ï¼šåŸºäºŽè¯­æ–™åº“çš„ç ”ç©¶èŒƒå¼æ—¨åœ¨éªŒè¯æˆ–ä¿®æ­£ç†è®ºï¼Œè€Œè¯­æ–™åº“é©±åŠ¨çš„ç ”ç©¶èŒƒå¼åˆ™ç€é‡äºŽè¯­è¨€æœ¬èº«çš„æå†™ã€‚\n' +
        'æ“ä½œæ‰‹æ®µï¼šåŸºäºŽè¯­æ–™åº“çš„ç ”ç©¶èŒƒå¼å¯èƒ½éœ€è¦å¤šä¸ªè¯­æ–™åº“è¿›è¡Œæ¯”è¾ƒï¼Œè€Œè¯­æ–™åº“é©±åŠ¨çš„ç ”ç©¶é€šå¸¸ä½¿ç”¨å•ä¸€è¯­æ–™åº“ã€‚\n' +
        '## 4. å‘å±•ä¸Žåº”ç”¨\n' +
        'æ–‡ç« è®¨è®ºäº†è¯­æ–™åº“è¯­è¨€å­¦çš„æœªæ¥å‘å±•ï¼ŒæŒ‡å‡ºå®ƒå·²ç»æˆä¸ºè¯­è¨€å­¦å®¶å’Œå…¶ä»–é¢†åŸŸç ”ç©¶è€…çš„ä¸»è¦ç ”ç©¶æ–¹æ³•ä¹‹ä¸€ã€‚åŒæ—¶ï¼Œæ–‡ç« ä¹Ÿæåˆ°äº†è¯­æ–™åº“åœ¨å›½å†…åº”ç”¨çš„çŽ°çŠ¶å’ŒæŒ‘æˆ˜ï¼Œå°¤å…¶æ˜¯åœ¨ä¸­å°å­¦æ•™è‚²ä¸­çš„åº”ç”¨å°šæœªæ™®åŠã€‚\n' +
        '\n' +
        '## 5. â€œè¯­æ–™åº“é©±åŠ¨â€ç ”ç©¶èŒƒå¼çš„å±€é™æ€§\n' +
        'æ–‡ç« æŒ‡å‡ºï¼Œç”±äºŽå…¶å“²å­¦åŸºç¡€å’Œç ”ç©¶æ‰‹æ®µçš„ç‰¹æ®Šæ€§ï¼Œè¯­æ–™åº“é©±åŠ¨çš„ç ”ç©¶èŒƒå¼å­˜åœ¨å±€é™æ€§ï¼Œå¯èƒ½éš¾ä»¥è¢«å…¶ä»–é¢†åŸŸçš„ç ”ç©¶è€…æŽ¥çº³ã€‚\n' +
        '\n' +
        '## 6. ç»“è¯­\n' +
        'æ–‡ç« æœ€åŽæ€»ç»“ï¼Œè¯­æ–™åº“è¯­è¨€å­¦è™½ç„¶å‘å±•åŽ†å²ä¸é•¿ï¼Œä½†å·²æˆä¸ºè·¨å­¦ç§‘é¢†åŸŸçš„é‡è¦ç ”ç©¶æ–¹æ³•ã€‚æ–‡ç« é¢„æµ‹ï¼ŒåŸºäºŽè¯­æ–™åº“çš„ç ”ç©¶èŒƒå¼ç”±äºŽå…¶å¼€æ”¾æ€§å’ŒåŒ…å®¹æ€§ï¼Œå¯èƒ½ä¼šæ¯”è¯­æ–™åº“é©±åŠ¨çš„ç ”ç©¶èŒƒå¼æœ‰æ›´å¹¿é˜”çš„å‘å±•å‰æ™¯ã€‚\n' +
        '\n' +
        'æ•´ä½“è€Œè¨€ï¼Œè¿™ç¯‡æ–‡ç« ä¸ºè¯»è€…æä¾›äº†è¯­æ–™åº“è¯­è¨€å­¦é¢†åŸŸçš„æ·±å…¥åˆ†æžï¼ŒåŒ…æ‹¬å…¶åŽ†å²ã€ä¸»è¦ç ”ç©¶èŒƒå¼åŠå…¶ç‰¹ç‚¹ã€é¢ä¸´çš„æŒ‘æˆ˜å’Œæœªæ¥çš„å‘å±•æ–¹å‘ã€‚'
    }
  ],
  currentSelect: '1',
  replaceMessage: (role, text) =>
    set((state) => {
      let newMessage = state.chatRecords;
      newMessage.at(-1)!.children = text;
      return { chatRecords: newMessage };
    }),
  setCurrentSelect: (id) =>
    set((state) => {
      id !== state.currentSelect && state.refreshChatRecords(id);
      return { currentSelect: id };
    }),
  refreshChatRecords: (id) =>
    set((state) => {
      console.log(id || state.currentSelect);
      return { chatRecords: state.chatRecords };
    }),
  addNewHistory: (title) =>
    set((state) => {
      let id = String(genKey.next().value);
      const date = new Date().toLocaleDateString();
      state.setCurrentSelect(id);
      return {
        chatHistories: [{ id, date, title }].concat(state.chatHistories),
      };
    }),
  sendMessage: (role, text) =>
    set((state) => ({
      chatRecords: state.chatRecords.concat({
        children: text,
        role: role,
      }),
    })),
}));

export const useChatInput = create<ChatInputStore>((set) => ({
  inputs: {
    text: '',
    files: [],
  },
  removeFiles: () => set((state) => ({inputs: {...state.inputs, files: state.inputs.files!.slice(1)}})),
  setText: (text) => set((state) => ({ inputs: { ...state.inputs, text } })),
  setFiles: (texts) => set((state) => ({inputs: {...state.inputs, files: texts}})),
  setPlugins: (name, res) =>
    set((state) => ({ inputs: { ...state.inputs, [name]: res } })),
}));
